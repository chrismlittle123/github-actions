name: Pulumi Destroy AWS
description: Destroy AWS infrastructure using Pulumi with OIDC authentication

inputs:
  role-to-assume:
    description: AWS IAM role ARN to assume via OIDC
    required: true
  pulumi-state-bucket:
    description: S3 bucket URL for Pulumi state (e.g. s3://my-pulumi-state)
    required: true
  environment:
    description: Pulumi stack/environment name
    required: true
  aws-region:
    description: AWS region
    required: false
    default: "eu-west-2"
  working-directory:
    description: Directory containing Pulumi project
    required: false
    default: "infra"
  timeout-minutes:
    description: Timeout in minutes for the destroy operation
    required: false
    default: "30"

runs:
  using: composite
  steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ inputs.role-to-assume }}
        aws-region: ${{ inputs.aws-region }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: pnpm

    - name: Install dependencies
      shell: bash
      run: pnpm install --frozen-lockfile
      working-directory: ${{ inputs.working-directory }}

    - name: Install Pulumi CLI
      shell: bash
      run: curl -fsSL https://get.pulumi.com | sh && echo "$HOME/.pulumi/bin" >> $GITHUB_PATH

    - name: Destroy
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      timeout-minutes: ${{ fromJSON(inputs.timeout-minutes) }}
      run: |
        export PATH="$HOME/.pulumi/bin:$PATH"
        pulumi login ${{ inputs.pulumi-state-bucket }}
        pulumi stack select ${{ inputs.environment }}
        pulumi refresh --yes
        pulumi destroy --yes
